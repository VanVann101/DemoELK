# ELK + .NET demo

–î–µ–º–æ —Å—Ç–µ–Ω–¥ –¥–ª—è –∞—Ç—Ç–µ—Å—Ç–∞—Ü–∏–∏: —Ç—Ä–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞ –∏ —Å—Ç–µ–∫ Elasticsearch/Kibana/Logstash –≤ –æ–¥–Ω–æ–º `docker-compose`.

## –°–µ—Ä–≤–∏—Å—ã
- `order-api` ‚Äî –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–∫–∞–∑—ã, —Ö–æ–¥–∏—Ç –≤ `inventory-service` –∏ `payment-service`, –ø–∏—à–µ—Ç –ª–æ–≥–∏.
- `inventory-service` ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ —Ç–æ–≤–∞—Ä–∞, –∏–Ω–æ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–µ—Ç 500/–¥–æ–ª–≥–∏–µ –æ—Ç–≤–µ—Ç—ã.
- `payment-service` ‚Äî –∏–º–∏—Ç–∏—Ä—É–µ—Ç –æ–ø–ª–∞—Ç—É: —É—Å–ø–µ—Ö / –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ / 500.
- `filebeat` ‚Äî —Å–æ–±–∏—Ä–∞–µ—Ç –ª–æ–≥–∏ –∏–∑ —Ñ–∞–π–ª–æ–≤ —Å–µ—Ä–≤–∏—Å–æ–≤ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ Logstash.
- `logstash` ‚Äî –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ª–æ–≥–∏ –æ—Ç Filebeat (–ø–æ—Ä—Ç 5044) –∏ –Ω–∞–ø—Ä—è–º—É—é –æ—Ç —Å–µ—Ä–≤–∏—Å–æ–≤ (–ø–æ—Ä—Ç 5000), –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –∏ –∫–ª–∞–¥—ë—Ç –≤ Elasticsearch.
- `elasticsearch`, `kibana` ‚Äî —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–æ–≤.

–í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –ª–æ–≥–∏—Ä—É—é—Ç –¥–≤—É–º—è —Å–ø–æ—Å–æ–±–∞–º–∏:
1. –í —Ñ–∞–π–ª—ã `/app/logs/*.log` (—Å–æ–±–∏—Ä–∞—é—Ç—Å—è Filebeat)
2. –ù–∞–ø—Ä—è–º—É—é –≤ Logstash —á–µ—Ä–µ–∑ HTTP (–ø–æ—Ä—Ç 5000)

## –ó–∞–ø—É—Å–∫
```bash
docker compose up --build
```
- Order API: http://localhost:8080
- **Swagger UI**: http://localhost:8080/swagger (–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API)
- Kibana: http://localhost:5601 (security –≤—ã–∫–ª—é—á–µ–Ω –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã)
- Logstash Beats input: tcp://localhost:5044
- Elasticsearch: http://localhost:9200

–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å: `docker compose down -v` (—É–¥–∞–ª–∏—Ç –¥–∞–Ω–Ω—ã–µ ES –∏ –ª–æ–≥–∏).

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è

### –ß–µ—Ä–µ–∑ Swagger UI (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
–û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:8080/swagger –∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:
1. –†–∞—Å–∫—Ä–æ–π—Ç–µ `POST /orders`
2. –ù–∞–∂–º–∏—Ç–µ "Try it out"
3. –ò–∑–º–µ–Ω–∏—Ç–µ `itemId` –Ω–∞ –Ω—É–∂–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π (1-7, —Å–º. —Ç–∞–±–ª–∏—Ü—É –≤—ã—à–µ)
4. –ù–∞–∂–º–∏—Ç–µ "Execute"
5. –í –æ—Ç–≤–µ—Ç–µ –ø–æ–ª—É—á–∏—Ç–µ `traceId` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤ Kibana

**–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤:** —Å–º. [TEST_SCENARIOS.md](TEST_SCENARIOS.md)

### –ß–µ—Ä–µ–∑ curl
–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑:
```bash
curl -X POST http://localhost:8080/orders ^
  -H "Content-Type: application/json" ^
  -d "{\"itemId\":1,\"quantity\":2,\"userId\":\"demo-user\"}"
```
–û—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç `traceId` (–¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏), –ª–æ–≥–∏ ‚Äî –≤ Kibana Discover.

–ü—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞:
```bash
curl http://localhost:8080/orders/{orderId}
```

## –ß—Ç–æ —Å–º–æ—Ç—Ä–µ—Ç—å –≤ Kibana
- **Discover**: –∏–Ω–¥–µ–∫—Å `dotnet-logs-*` ‚Äî –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ Logstash–æ–º –ª–æ–≥–∏ –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤:
  - **order-api**: JSON —Ñ–æ—Ä–º–∞—Ç
  - **inventory-service**: Key/Value —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç
  - **payment-service**: Logfmt —Ñ–æ—Ä–º–∞—Ç
  
–í—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã –ø–∞—Ä—Å—è—Ç—Å—è Logstash –∏ –ø—Ä–∏–≤–æ–¥—è—Ç—Å—è –∫ –µ–¥–∏–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ —Å –ø–æ–ª—è–º–∏: `service`, `level`, `timestamp`, `traceId`, `msg`.

**–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≤ Kibana:**
- –ü–æ —Å–µ—Ä–≤–∏—Å—É: `service:"order-api"`
- –ü–æ traceId: `traceId:"abc123"`
- –ü–æ —É—Ä–æ–≤–Ω—é: `level:"error"`
- –ò—Å–∫–ª—é—á–∏—Ç—å –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞: `NOT tags:_jsonparsefailure`

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –õ–æ–≥–∏ —Å —Ç–µ–≥–æ–º `_jsonparsefailure` ‚Äî —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ JSON (–æ–±—ã—á–Ω–æ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ª–æ–≥–∏ .NET –∏–ª–∏ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏). –û–Ω–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∫–∞–∫ plain text —Å `service:"unknown-service"`.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **Filebeat** –¥–ª—è —Å–±–æ—Ä–∞ –ª–æ–≥–æ–≤:
1. –°–µ—Ä–≤–∏—Å—ã –ø–∏—à—É—Ç –ª–æ–≥–∏ –≤ —Ñ–∞–π–ª—ã `/app/logs/*.log`
2. Filebeat —á–∏—Ç–∞–µ—Ç —Ñ–∞–π–ª—ã –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ Logstash (–ø–æ—Ä—Ç 5044)
3. Logstash –ø–∞—Ä—Å–∏—Ç —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ Elasticsearch
4. Kibana –≤–∏–∑—É–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ª–æ–≥–∏

**–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏:**
- **–°–µ—Ä–≤–∏—Å—ã (.NET)**: –ø–∏—à—É—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏ –≤ —Ñ–∞–π–ª—ã —á–µ—Ä–µ–∑ Serilog
- **Filebeat**: –ª–µ–≥–∫–æ–≤–µ—Å–Ω—ã–π shipper, —á–∏—Ç–∞–µ—Ç —Ñ–∞–π–ª—ã –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Ç—Ä–æ–∫–∏ –≤ Logstash
- **Logstash**: –ø–∞—Ä—Å–∏—Ç –≤—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã (JSON, Key/Value, Logfmt), –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –∏ –æ–±–æ–≥–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ
- **Elasticsearch**: —Ö—Ä–∞–Ω–∏—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏
- **Kibana**: –ø–æ–∏—Å–∫ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è

## –§–æ—Ä–º–∞—Ç—ã –ª–æ–≥–æ–≤
–ü—Ä–æ–µ–∫—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É —Å —Ç—Ä–µ–º—è —Ä–∞–∑–Ω—ã–º–∏ —Ñ–æ—Ä–º–∞—Ç–∞–º–∏ –ª–æ–≥–æ–≤:
1. **order-api**: JSON (–ø–æ–ª–Ω—ã–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç Serilog)
   - –í—Å–µ —Å–≤–æ–π—Å—Ç–≤–∞ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
   - `TraceId`, `Level`, `Timestamp` –∏ –¥—Ä—É–≥–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
   - **Filebeat –ø–∞—Ä—Å–∏—Ç JSON** —Å `json.keys_under_root: true`
2. **inventory-service**: Key/Value —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç (custom template)
   - –§–æ—Ä–º–∞—Ç: `inventory | timestamp | level=X | item=Y | traceId=Z | msg=...`
   - **Filebeat –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–∞–∫ plain text**, –ø–∞—Ä—Å–∏–Ω–≥ –≤ Logstash —á–µ—Ä–µ–∑ grok
3. **payment-service**: Logfmt —Ñ–æ—Ä–º–∞—Ç (key="value" pairs)
   - –§–æ—Ä–º–∞—Ç: `timestamp="..." level=X service=Y traceId="Z" message="..."`
   - **Filebeat –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–∞–∫ plain text**, –ø–∞—Ä—Å–∏–Ω–≥ –≤ Logstash —á–µ—Ä–µ–∑ grok

Logstash –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –≤—Å–µ —Ç—Ä–∏ —Ñ–æ—Ä–º–∞—Ç–∞ –≤ –µ–¥–∏–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è Elasticsearch.

**–í–∞–∂–Ω–æ:** –í JSON –ª–æ–≥–∞—Ö (order-api) –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, `{TraceId}`, `{@Order}`) —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –≤ JSON, –∞ –Ω–µ –ø–æ–¥—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –≤ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥–µ–ª–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ –ø–æ–ª—è–º –≤ Kibana.

## –†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–∞—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ (Distributed Tracing)
–ü—Ä–æ–µ–∫—Ç —Ä–µ–∞–ª–∏–∑—É–µ—Ç –ø—Ä–æ—Å—Ç—É—é —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—É—é —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫—É —á–µ—Ä–µ–∑ HTTP –∑–∞–≥–æ–ª–æ–≤–æ–∫ `X-Trace-Id`:
1. **order-api** –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π `traceId` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
2. –ü–µ—Ä–µ–¥–∞—ë—Ç `traceId` –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ inventory-service –∏ payment-service
3. –í—Å–µ —Ç—Ä–∏ —Å–µ—Ä–≤–∏—Å–∞ –ª–æ–≥–∏—Ä—É—é—Ç –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ `traceId`
4. –í Kibana –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –≤—Å–µ –ª–æ–≥–∏ –æ–¥–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ –ø–æ–ª—é `traceId`

–ü—Ä–∏–º–µ—Ä –ø–æ–∏—Å–∫–∞ –≤ Kibana: `traceId:"abc123def456"` –ø–æ–∫–∞–∂–µ—Ç –≤–µ—Å—å –ø—É—Ç—å –∑–∞–ø—Ä–æ—Å–∞ —á–µ—Ä–µ–∑ –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã.

## –ü–æ–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è –¥–µ–º–æ
–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏** –Ω–∞ –æ—Å–Ω–æ–≤–µ `itemId`:

| itemId | –°—Ü–µ–Ω–∞—Ä–∏–π | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|----------|
| 1 | ‚úÖ **Success** | –ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω |
| 2 | ‚ùå **Out of Stock** | –¢–æ–≤–∞—Ä–∞ –Ω–µ—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ (inventory) |
| 3 | üí≥ **Insufficient Funds** | –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ (payment) |
| 4 | üî• **Inventory Error** | –û—à–∏–±–∫–∞ 500 –≤ inventory service |
| 5 | üî• **Payment Error** | –û—à–∏–±–∫–∞ 500 –≤ payment service |
| 6 | üêå **Slow Inventory** | –ó–∞–¥–µ—Ä–∂–∫–∞ 2 —Å–µ–∫ –≤ inventory service |
| 7 | üêå **Slow Payment** | –ó–∞–¥–µ—Ä–∂–∫–∞ 2 —Å–µ–∫ –≤ payment service |

**–ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤:**
```bash
# –£—Å–ø–µ—à–Ω—ã–π –∑–∞–∫–∞–∑
curl -X POST http://localhost:8080/orders -H "Content-Type: application/json" -d "{\"itemId\":1,\"quantity\":2,\"userId\":\"demo-user\"}"

# –ù–µ—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ
curl -X POST http://localhost:8080/orders -H "Content-Type: application/json" -d "{\"itemId\":2,\"quantity\":2,\"userId\":\"demo-user\"}"

# –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤
curl -X POST http://localhost:8080/orders -H "Content-Type: application/json" -d "{\"itemId\":3,\"quantity\":2,\"userId\":\"demo-user\"}"
```

